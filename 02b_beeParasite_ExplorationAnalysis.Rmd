---
title: "02b_beeParasite_ExploratoryAnalysis"
author: "Jessie Dodge"
date: "2024-05-24"
output:
  word_document: default
  pdf_document: 
    latex_engine: xelatex
    keep_tex: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = TRUE) 
```

# Library
```{r, include = FALSE}
source(file="01i_beeReproDev_MasterData.R")
```

# Data org
```{r}
# To add labels for sites sampled both years
data<-data %>% group_by(Site) %>%
  mutate(Year2 = n_distinct(Year)) %>% 
  #mutate(Year3 = as.factor(ifelse(Year2 == 2, "B", "")))
  mutate(Year3 = as.factor(ifelse(Year2 == 2, Site, "")))

# turn SiteYr to rownames
data<-data %>% column_to_rownames(var = "SiteYr")

# re org and select columns you want to keep
data2<-data[,c(1:3, 14:42, 46:49, 53, 63:64, 67:75)]
# Count/proportion data 
colSums(data2[,c(5:20, 43:48)] > 0) # Crops are only in 3 sites, and Barren are only in 2 sites
data2<-data2[,-c(43,45)] # omit crops and barren

# omit site with no provisioned cells - zeros omitted (zo)
zo.data<-filter(data2, nTotProvised > 0)

# Data subsets
# for count/weight data
## all
or.data <- filter(zo.data, oligRatio > 0)
w.data <- filter(zo.data, avgOligMass_mg > 0)
fw.data <- filter(zo.data, avgOligFMass_mg > 0)
mw.data <- filter(zo.data, avgOligMMass_mg > 0)
lw.data <- filter(zo.data, avgOligLarvMass_mg > 0)

# remove T. stan outlier
zo.data.or <- filter(zo.data, nTstanCells < 10)
fw.data.or <- filter(zo.data, nTstanCells < 10 & avgOligFMass_mg > 0)
#or.data.or <- filter(or.data, nTstanCells < 10)
```

# Questions
Q1) How does landscape and climate variation affect bee parasitism?
  * Proposed analyses: MLRs 
    ** Parasite abundance ~ Year + Hab + Landscape + Climate + Floral
      ** What variables to include?
        ** Predictor vars to include in stp-wise model: https://journals.lww.com/picp/fulltext/2017/08030/Common_pitfalls_in_statistical_analysis__Logistic.9.aspx
          1) what vars have a sig, univariate relationship (P < 0.1)
          2) Avoid highly correlated variables

Q2) How does parasitism abundance affect bee fitness traits?
  * Proposed analyses: SLRs 
    ** bee % ~ parasite %
    ** bee abundance ~ parasite abundance
    ** bee mass ~ parasite abundance (2021)
    ** F% ~ parasite abundance (2021)

# General 
For significantly different variables between years
## Field days between years
```{r}
zo.data %>% group_by(Year) %>% 
  summarise_at(c("DD_accumulated"), 
               list(mean = ~mean(.), se = ~ sd(.)/sqrt(length(.))), na.rm = TRUE)
```

## Sites with 0 provisions or bee broods
```{r}
data %>% group_by(Year) %>% tally(nTotProvised == 0) # 1 in 2020, 6 in 2021
data %>% group_by(Year) %>% tally(nOligGrowth == 0) # 1 in 2020, 7 in 2021
```

## T.stan nest colonization %
```{r}
data %>% group_by(Year) %>% 
  summarise_at(c("nTstanCells", "nTotProvised"), sum) %>%
  mutate(rel.freq = paste0(round(100* ((nTstanCells) /(nTotProvised)), 2), "%"))

## By hab
data %>% group_by(Habitat) %>%
 summarise_at(c("nTstanCells", "nTotProvised"), sum)%>%
mutate(rel.freq = paste0(round(100* ((nTstanCells) /(nTotProvised)), 2), "%"))
```

# Predictor vars to include in MLR
## 1) Sig univariate relationships
### *Note* Need to update data sets
### Provisioned cells
Note: you will want to use all data, zeros included for Provisioned cells analysis - true zeros
#### Data prep
```{r}
pvars <- data2[,c(2:4, 21:46)]
x = colnames(pvars) # make list of response vars names

tpcdata <- data2[,c(5, 2:4, 21:46)]

tpc.out <- unlist(lapply(1, function(n) combn(x, 1, FUN=function(row) paste0("nTotProvised ~ ", paste0(row, collapse = "+")))))
tpc.out
```

#### Data exploration
```{r}
summary(tpcdata)
ggplot(tpcdata, aes(nTotProvised, fill = Habitat)) + geom_histogram(binwidth = 5) + facet_grid(Habitat ~ 
    ., margins = TRUE) # not really normally distributed

ggplot(tpcdata, aes(nTotProvised, fill = Year)) + geom_histogram(binwidth = 5) + facet_grid(Year ~ 
    ., margins = TRUE) # somewhat Gamma distributed

with(tpcdata, tapply(nTotProvised, Habitat, function(x) {
    sprintf("M (SD) = %1.2f (%1.2f)", mean(x), sd(x))
})) # Variance is higher than mean in Burned sites

with(tpcdata, tapply(nTotProvised, Year, function(x) {
    sprintf("M (SD) = %1.2f (%1.2f)", mean(x), sd(x))
})) # Variance lower than mean - not much difference in means
```
Analysis methods you might consider
https://stats.oarc.ucla.edu/r/dae/negative-binomial-regression/
Below is a list of some analysis methods you may have encountered. Some of the methods listed are quite reasonable, while others have either fallen out of favor or have limitations.

* Negative binomial regression - Negative binomial regression can be used for over-dispersed count data, that is when the conditional variance exceeds the conditional mean. It can be considered as a generalization of Poisson regression since it has the same mean structure as Poisson regression and it has an extra parameter to model the over-dispersion. If the conditional distribution of the outcome variable is over-dispersed, the confidence intervals for the Negative binomial regression are likely to be wider as compared to those from a Poisson regression model.

* Poisson regression – Poisson regression is often used for modeling count data. Poisson regression has a number of extensions useful for count models.

* Zero-inflated regression model – Zero-inflated models attempt to account for excess zeros. In other words, two kinds of zeros are thought to exist in the data, “true zeros” and “excess zeros”. Zero-inflated models estimate two equations simultaneously, one for the count model and one for the excess zeros.

* OLS regression – Count outcome variables are sometimes log-transformed and analyzed using OLS regression. Many issues arise with this approach, including loss of data due to undefined values generated by taking the log of zero (which is undefined), as well as the lack of capacity to model the dispersion.

#### SLR
nTotProvised were not normal unless sqrt
```{r}
#To have the regression coefficients
tpc.mods = bind_rows(lapply(tpc.out, function(frml) {
  a = tidy(lm(frml, data=tpcdata))
  a$frml = frml
  return(a)
}))

head(tpc.mods)

# check modes
tpc.mod.chk = bind_rows(lapply(tpc.out, function(frml) {
  b = plot(lm(frml, data=tpcdata))
  b$frml= frml
  return(b)
}))

write.csv(tpc.mods, "tables/provisionedCells.lm.coeffs.csv")
```
Not normal - Transformation vs GLM. Provisioned cells are count data that follow a Poisson dist.

#### GLM - Poisson
```{r}
#To have the regression coefficients
tpc.mods = bind_rows(lapply(tpc.out, function(frml) {
  a = tidy(glm(frml, data=tpcdata, family = poisson()))
  a$frml = frml
  return(a)
}))

head(tpc.mods)
write.csv(tpc.mods, "tables/provisionedCells.glm.pois.coeffs.csv")

# to get model results
tpc.mods2 = bind_rows(lapply(tpc.out, function(frml) {
 a = glance(glm(frml, data=tpcdata, family = poisson()))
 a$frml = frml
 return(a)
}))

head(tpc.mods2)
write.csv(tpc.mods2, "tables/provisionedCells.glm.pois.results.csv")
```

#### GLM - Negative Binomial
```{r}
#To have the regression coefficients
tpc.mods = bind_rows(lapply(tpc.out, function(frml) {
  a = tidy(glm.nb(frml, data=tpcdata))
  a$frml = frml
  return(a)
}))

head(tpc.mods)
write.csv(tpc.mods, "tables/provisionedCells.glm.nb.coeffs.csv")

# to get model results
#tpc.mods2 = bind_rows(lapply(tpc.out, function(frml) {
 #a = glance(glm.nb(frml, data=tpcdata))
 #a$frml = frml
 #return(a)
#})) # Won't work: Some attributes are incompatible.

head(tpc.mods2)
write.csv(tpc.mods2, "tables/provisionedCells.glm.nb.results.csv")

tpcm1<-glm.nb(nTotProvised ~ Ann_ppt_mm, data = tpcdata)
glance(tpcm1)
```

#### *Nested GLM - Gaussian*
```{r}
tpcdata <- zo.data[,c(5, 2:4, 21:48)]
Beta <- vector(length = nrow(tpcdata))
for (i in nrow(tpcdata)) {
  mi <- summary(lm(nTotProvised ~ HLI, subset = (Habitat == i), data = tpcdata))
  Beta[i]<- Mi$coefficients [2,1]
}

```

### O. lig 
Note: Make sure to only use data with provisioned cells
#### Dat prep
```{r}
pvars <- data2[,c(2:4, 21:46)]
x = colnames(pvars) # make list of response vars names

# Count data
ondata <- zo.data[,c(6, 2:4, 21:46)]
on.out <- unlist(lapply(1, function(n) combn(x, 1, FUN=function(row) paste0("nOligGrowth ~ ", paste0(row, collapse = "+")))))
#on.out

# Ratio data
ordata<- zo.data[,c(17, 2:4, 21:46)]
or.out <- unlist(lapply(1, function(n) combn(x, 1, FUN=function(row) paste0("oligRatio ~ ", paste0(row, collapse = "+")))))
#or.out
```
#### Count
##### SLRs
```{r}
on.out <- unlist(lapply(1, function(n) combn(x, 1, FUN=function(row) paste0("nOligGrowth ~ ", paste0(row, collapse = "+")))))
on.out

#To have the regression coefficients
on.mods = bind_rows(lapply(on.out, function(frml) {
  a = tidy(lm(frml, data=ondata))
  a$frml = frml
  return(a)
}))

# check models
on.mod.chk = bind_rows(lapply(on.out, function(frml) {
  b = plot(lm(frml, data=ondata))
  return(b)
}))

# many models are not normal and have curved residules

head(on.mods)
write.csv(on.mods, "tables/nOlig.lm.coeffs.csv")
```
Assumptions of linear models are Violated. Transform model or use GLM?

##### SLRs - transformed
```{r}
on.out <- unlist(lapply(1, function(n) combn(x, 1, FUN=function(row) paste0("sqrt(nOligGrowth) ~ ", paste0(row, collapse = "+")))))
on.out

#To have the regression coefficients
on.mods = bind_rows(lapply(on.out, function(frml) {
  a = tidy(lm(frml, data=ondata))
  a$frml = frml
  return(a)
}))

head(on.mods)
write.csv(on.mods, "tables/nOlig.sqrt.lm.coeffs.csv")
```

##### GLM - Poisson
```{r}
#To have the regression coefficients
on.mods = bind_rows(lapply(on.out, function(frml) {
  a = tidy(glm(frml, data=ondata, family = poisson()))
  a$frml = frml
  return(a)
}))

head(on.mods)
write.csv(on.mods, "tables/nOlig.glm.pois.coeffs.csv")

# to get model results
on.mods2 = bind_rows(lapply(on.out, function(frml) {
 a = glance(glm(frml, data=ondata, family = poisson()))
 a$frml = frml
 return(a)
}))

head(on.mods2)
write.csv(on.mods2, "tables/nOlig.glm.pois.results.csv")
```

##### GLM - Negative Binomial
```{r}
on.out <- unlist(lapply(1, function(n) combn(x, 1, FUN=function(row) paste0("nOligGrowth ~ ", paste0(row, collapse = "+")))))
on.out

#To have the regression coefficients
on.mods = bind_rows(lapply(on.out, function(frml) {
  a = tidy(glm.nb(frml, data=ondata))
  a$frml = frml
  return(a)
}))

head(on.mods)
write.csv(on.mods, "tables/nOlig.glm.nb.coeffs.csv")

# to get model results
on.mods2 = bind_rows(lapply(on.out, function(frml) {
 a = tidy(glm.nb(frml, data=ondata))
 a$frml = frml
 return(a)
}))

head(on.mods2)
write.csv(on.mods2, "tables/nOlig.glm.nb.results.csv")
```

#### Ratio (%)
##### SLR
```{r}
#To have the regression coefficients
or.mods = bind_rows(lapply(or.out, function(frml) {
  a = tidy(lm(frml, data=ordata))
  a$frml = frml
  return(a)
}))

head(or.mods)
write.csv(or.mods, "tables/OligRatio.lm.coeffs.csv")

# to get model results
or.mods2 = bind_rows(lapply(or.out, function(frml) {
 a = glance(glm(frml, data=ordata, family = poisson()))
 a$frml = frml
 return(a)
}))

head(or.mods2)
write.csv(or.mods2, "tables/OligRatio.lm.results.csv")

# check models
on.mod.chk = bind_rows(lapply(on.out, function(frml) {
  b = plot(lm(frml, data=ondata))
  return(b)
}))

# many models are not normal and have curved or megaphone residuals
```

##### GLM - binomial
```{r}
#To have the regression coefficients
or.mods = bind_rows(lapply(or.out, function(frml) {
  a = tidy(glm(frml, data=ordata, family = binomial()))
  a$frml = frml
  return(a)
}))

head(or.mods)
write.csv(or.mods, "tables/OligRatio.glm.bin.coeffs.csv")

or.mods2 = bind_rows(lapply(or.out, function(frml) {
 a = glance(glm(frml, data=ordata, family = binomial()))
 a$frml = frml
 return(a)
}))
head(or.mods2)
write.csv(or.mods2, "tables/OligRatio.glm.bin.results.csv")
```


### T.stan
Omit outlier
#### Data org
```{r}
pvars <- data2[,c(2:4, 21:46)]
x = colnames(pvars) # make list of response vars names

# Count
tndata <- zo.data.or[,c(7, 2:4, 21:46)]
tn.out <- unlist(lapply(1, function(n) combn(x, 1, FUN=function(row) paste0("nTstanCells ~ ", paste0(row, collapse = "+")))))
#tn.out

# Ratio
trdata <- zo.data.or[,c(18, 2:4, 21:46)]
tr.out <- unlist(lapply(1, function(n) combn(x, 1, FUN=function(row) paste0("tstanRatio ~ ", paste0(row, collapse = "+")))))
#tr.out
```

#### Count
##### GLM - Poisson
```{r}
#To have the regression coefficients
tn.mods = bind_rows(lapply(tn.out, function(frml) {
  a = tidy(glm(frml, data=tndata, family = poisson()))
  a$frml = frml
  return(a)
}))

head(tn.mods)
write.csv(tn.mods, "tables/nTstan.glm.coeffs.csv")

tn.mods2 = bind_rows(lapply(tn.out, function(frml) {
 a = glance(glm(frml, data=tndata, family = poisson()))
 a$frml = frml
 return(a)
}))

head(tn.mods2)
write.csv(tn.mods2, "tables/nTstan.glm.results.csv")
```

##### GLM - Quasi-Poisson
```{r}
#To have the regression coefficients
tn.qpmods = bind_rows(lapply(tn.out, function(frml) {
  a = tidy(glm(frml, data=tndata, family = quasipoisson()))
  a$frml = frml
  return(a)
}))

head(tn.qpmods)
write.csv(tn.qpmods, "tables/nTstan.glm-qp.coeffs.csv")

# results will be the exact same as poisson results minus AIC scores
```

##### GLM - Negative Binomial
```{r}
#To have the regression coefficients
tn.mods = bind_rows(lapply(tn.out, function(frml) {
  a = tidy(glm.nb(frml, data=tndata))
  a$frml = frml
  return(a)
}))

head(tn.mods)
write.csv(tn.mods, "tables/nTstan.glm.nb.coeffs.csv")
```

#### Ratio (%)
##### GLM - binomial
```{r}
#To have the regression coefficients
tr.mods = bind_rows(lapply(tr.out, function(frml) {
  a = tidy(glm(frml, data=trdata, family = binomial()))
  a$frml = frml
  return(a)
}))

head(tr.mods)
write.csv(tr.mods, "tables/TstanRatio.glm.bin.coeffs.csv")

tr.mods2 = bind_rows(lapply(tr.out, function(frml) {
 a = glance(glm(frml, data=trdata, family = binomial()))
 a$frml = frml
 return(a)
}))
head(tr.mods2)
write.csv(tr.mods2, "tables/TstanRatio.glm.bin.results.csv")
```

#### Site
##### lms
```{r}
lm1<- lm(nTstanCells ~ Year, data = zo.data)
lm1<- lm(log(nTstanCells+1,base = 10) ~ Year, data = zo.data)
lm1<- lm(log(nTstanCells+1,base = 10) ~ Year, data = zo.data.or)
lm1<- lm(sqrt(nTstanCells) ~ Year, data = zo.data.or)
plot(lm1) # megaphone resids, somewhat better? outlier
tidy(lm1) 

lm2<- lm(nTstanCells ~ Habitat, data = zo.data)
lm2<- lm(log(nTstanCells+1, base=10) ~ Habitat, data = zo.data)
lm2<- lm(sqrt(nTstanCells) ~ Habitat, data = zo.data.or)
plot(lm2) # megaphone resids, some outliers
tidy(lm2) # not sig

lm3<- lm(nTstanCells ~ HLI, data = zo.data)
tidy(lm3) # not sig
```
Significant vars: none

##### glms
```{r}
glm1<-glm(nTstanCells ~ Year, data = zo.data.or, family = poisson())
sglm1<-tidy(glm1) # not sig
kable(sglm1, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

glm2<-glm(nTstanCells ~ Habitat, data = zo.data, family = poisson())
glm2<-glm(nTstanCells ~ Habitat, data = zo.data.or, family = poisson())
sglm2<-tidy(glm2) # sig
kable(sglm2, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

glm3<-glm(nTstanCells ~ HLI, data = zo.data, family = poisson())
glm3<-glm(nTstanCells ~ HLI, data = zo.data.or, family = poisson())
sglm3<-tidy(glm3) # not sig when outlier is removed
kable(sglm3, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )
```
Significant vars: Habitat

#### Climate variables

##### lms
```{r}
## Climate Normals
lm4<- lm(nTstanCells ~ Ann_ppt_mm, data = zo.data)
tidy(lm4) # not sig
lm5<- lm(nTstanCells ~ Ann_tmax_C, data = zo.data)
tidy(lm5) # not sig
lm6<- lm(nTstanCells ~ Ann_tmean_C, data = zo.data)
tidy(lm6) # not sig
lm7<- lm(nTstanCells ~ Ann_tmin_C, data = zo.data)
tidy(lm7) # not sig

## Jan - June Climate
lm8<- lm(nTstanCells ~ bi_ppt_mm, data = zo.data)
tidy(lm8) # not sig
lm9<- lm(nTstanCells ~ bi_tmax_C, data = zo.data)
tidy(lm9) # not sig
lm10<- lm(nTstanCells ~ bi_tmean_C, data = zo.data)
tidy(lm10) # not sig
lm11<- lm(nTstanCells ~ bi_tmin_C, data = zo.data)
tidy(lm11) # not sig

## May - July Climate
lm12<- lm(nTstanCells ~ qrt_ppt_mm, data = zo.data)
tidy(lm12) # not sig
lm13<- lm(nTstanCells ~ qrt_tmax_C, data = zo.data)
tidy(lm13) # not sig
lm14<- lm(nTstanCells ~ qrt_tmean_C, data = zo.data)
tidy(lm14) # not sig
lm15<- lm(nTstanCells ~ qrt_tmin_C, data = zo.data)
tidy(lm15) # not sig

## ADD
lm16<-lm(nTstanCells ~ DD_accumulated, data = zo.data)
tidy(lm16) # significant
lm16<-lm(nTstanCells ~ DD_accumulated, data = zo.data.or)
tidy(lm16) # not sig
```
Significant vars: DD_accumulated, but not when outlier is removed

##### glms
```{r}
## Climate Normals
glm4<- glm(nTstanCells ~ Ann_ppt_mm, data = zo.data.or, family = poisson())
cglm4<- tidy(glm4) # not sig
kable(cglm4, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

glm5<- glm(nTstanCells ~ Ann_tmax_C, data = zo.data.or, family = poisson())
cglm5<- tidy(glm5) # not sig
kable(cglm5, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

glm6<- glm(nTstanCells ~ Ann_tmean_C, data = zo.data.or, family = poisson())
cglm6<- tidy(glm6) # not sig
kable(cglm6, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

glm7<- glm(nTstanCells ~ Ann_tmin_C, data = zo.data.or, family = poisson())
cglm7<- tidy(glm7) # sig
kable(cglm7, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

## Jan - June Climate
glm8<- glm(nTstanCells ~ bi_ppt_mm, data = zo.data.or, family = poisson())
cglm8<- tidy(glm8) # not sig
kable(cglm8, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

glm9<- glm(nTstanCells ~ bi_tmax_C, data = zo.data.or, family = poisson())
cglm9<- tidy(glm9) # marginally sig
kable(cglm9, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

glm10<- glm(nTstanCells ~ bi_tmean_C, data = zo.data.or, family = poisson())
cglm10<- tidy(glm10) # marginally sig
kable(cglm10, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

glm11<- glm(nTstanCells ~ bi_tmin_C, data = zo.data.or, family = poisson())
cglm11<- tidy(glm11) # not sig
kable(cglm11, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

## May - July Climate
glm12<- glm(nTstanCells ~ qrt_ppt_mm, data = zo.data.or, family = poisson())
cglm12<- tidy(glm12) # not sig
kable(cglm12, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

glm13<- glm(nTstanCells ~ qrt_tmax_C, data = zo.data.or, family = poisson())
cglm13<- tidy(glm13) # not sig
kable(cglm13, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

glm14<- glm(nTstanCells ~ qrt_tmean_C, data = zo.data.or, family = poisson())
cglm14<- tidy(glm14) # not sig
kable(cglm14, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

glm15<- glm(nTstanCells ~ qrt_tmin_C, data = zo.data.or, family = poisson())
cglm15<- tidy(glm15) # not sig
kable(cglm15, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

## ADD
glm16<-glm(nTstanCells ~ DD_accumulated, data = zo.data.or, family = poisson())
cglm16<-tidy(glm16) # marginally sig
kable(cglm16, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )
```
Significant vars: Ann_tmin_C
Marginally sig vars: bi_tmax_C, bi_tmean_C, and DD_accumulated

#### Floral

##### lms
```{r}
flm1<- lm(nTstanCells ~ stemabun, data = zo.data)
tidy(flm1) # not sig
flm2<- lm(nTstanCells ~ stemdiv, data = zo.data)
tidy(flm2) # not sig
flm3<- lm(nTstanCells ~ stemrich, data = zo.data)
tidy(flm3) # not sig
```
Significant vars: none

##### glms
```{r}
fglm1<- glm(nTstanCells ~ stemabun, data = zo.data.or, family = poisson())
fsglm1<-tidy(fglm1) # not sig
kable(fsglm1, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

fglm2<- glm(nTstanCells ~ stemdiv, data = zo.data.or, family = poisson())
fsglm2<-tidy(fglm2) # not sig
kable(fsglm2, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

fglm3<- glm(nTstanCells ~ stemrich, data = zo.data.or, family = poisson())
fsglm3<-tidy(fglm3) # not sig
kable(fsglm3, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )
```
Significant vars: none

#### Tree
##### lms
```{r}
tlm1<- lm(nTstanCells ~ meanTreeCC, data = zo.data)
tidy(tlm1) # not sig
tlm2<- lm(nTstanCells ~ Dead_BA_ha, data = zo.data)
tidy(tlm2) # not sig
tlm3<- lm(nTstanCells ~ Live_BA_ha, data = zo.data)
tidy(tlm3) # not sig
```
Significant vars: none

##### glms
```{r}
tglm1<- glm(nTstanCells ~ meanTreeCC, data = zo.data.or, family = poisson())
ttglm1<-tidy(tglm1) # not sig
kable(ttglm1, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

tglm2<- glm(nTstanCells ~ Dead_BA_ha, data = zo.data.or, family = poisson())
ttglm2<-tidy(tglm2) # not sig
kable(ttglm2, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

tglm3<- glm(nTstanCells ~ Live_BA_ha, data = zo.data.or, family = poisson())
ttglm3<-tidy(tglm3) # not sig
kable(ttglm3, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )
```
Significant vars: none

#### Landscape

##### lms
```{r}
llm1<- lm(nTstanCells ~ EVT_H, data = zo.data)
tidy(llm1) # not sig
llm2<- lm(nTstanCells ~ EVT_rich, data = zo.data)
tidy(llm2) # marginally sig
llm3<- lm(nTstanCells ~ EVT_J, data = zo.data)
tidy(llm3) # not sig
llm4<- lm(nTstanCells ~ Barren, data = zo.data)
tidy(llm4) # not sig
llm5<- lm(nTstanCells ~ Coniferous_Forest, data = zo.data)
tidy(llm5) # not sig
llm6<- lm(nTstanCells ~ Deciduous_Forest, data = zo.data)
tidy(llm6) # not sig
llm7<- lm(nTstanCells ~ Rangeland, data = zo.data) # probably correlated with Habitat type
tidy(llm7) # sig
llm8<- lm(nTstanCells ~ WUI, data = zo.data)
tidy(llm8) # not sig
```
Significant vars: none
Marginally sig vars: EVT_rich

##### glms
```{r}
lglm1<- glm(nTstanCells ~ EVT_H, data = zo.data.or, family = poisson())
liglm1<-tidy(lglm1) # sig
kable(liglm1, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

lglm2<- glm(nTstanCells ~ EVT_rich, data = zo.data.or, family = poisson())
liglm2<-tidy(lglm2) # sig
kable(liglm2, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

lglm3<- glm(nTstanCells ~ EVT_J, data = zo.data.or, family = poisson())
liglm3<-tidy(lglm3) # sig
kable(liglm3, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

lglm4<- glm(nTstanCells ~ Barren, data = zo.data.or, family = poisson())
ltglm4<-tidy(lglm4) # sig
kable(ltglm4, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

lglm5<- glm(nTstanCells ~ Coniferous_Forest, data = zo.data.or, family = poisson())
ltglm5<-tidy(lglm5) # sig
kable(ltglm5, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

lglm6<- glm(nTstanCells ~ Deciduous_Forest, data = zo.data.or, family = poisson())
ltglm6<-tidy(lglm6) # not sig
kable(ltglm6, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

lglm7<- glm(nTstanCells ~ Rangeland, data = zo.data.or, family = poisson()) 
ltglm7<-tidy(lglm7) # not sig (is sig with outlier)
kable(ltglm7, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3 )

lglm8<- glm(nTstanCells ~ WUI, data = zo.data.or, family = poisson())
ltglm8<-tidy(lglm8) # sig
kable(ltglm8, col.names = c("Term","Estimate", "Std. Error", "*z-value*", "*P-value*"), digits = 3)
```
Significant vars: EVT_H, EVT_rich, EVT_J, Barren, Coniferous_Forest, Rangeland, and WUI

##### WUI effects on Olig
Out of curiosity -
```{r}
oglm1<- glm(nOligGrowth ~ WUI, data = zo.data.or, family = poisson())
summary(oglm1)
plot(oglm1)
```

#### Tables
##### Site
```{r message=FALSE, results='asis'} 
stargazer(glm1, glm2, glm3, type = "text",
  title = "Univariate variable effects on *T. stansburyi* abundance",
  column.labels = c("Year", "Habitat", "HLI"), 
  colnames = FALSE, model.numbers = FALSE,
  dep.var.caption = " ", dep.var.labels = "Site variables",
  covariate.labels = c("Year - 2021", "Habitat - Control", "Habitat - Treated", "HLI", "Constant"),
  keep.stat = c("n"), # number of observations. use "ll" for log likelihood
  single.row=TRUE,
  add.lines = list(c("AIC", round(AICc(glm1), 1), round(AICc(glm2), 1), round(AICc(glm3), 1))),
  notes.align = "l",
  out = "tables/univar.site.txt")
```

##### Climate
```{r message=FALSE, results='asis'} 
# Normals
stargazer(glm4, glm5, glm6, glm7, type = "text",
  title = "Univariate variable effects on *T. stansburyi* abundance",
  colnames = FALSE, model.numbers = FALSE,
  dep.var.caption = "Climate variables", dep.var.labels = "Average 30-year normals",
  covariate.labels = c("Precipitation (mm)", "Max temperature (°C)", "Mean temperature (°C)", "Min temperature (°C)", "Constant"),
  keep.stat = c("n"), # number of observations. use "ll" for log likelihood
  single.row=TRUE,
  add.lines = list(c("AIC", round(AICc(glm4), 1), round(AICc(glm5), 1), round(AICc(glm6), 1), 
                     round(AICc(glm7), 1))),
  notes.align = "l", out = "tables/univar.climate-normals.txt")

# Jan-June
stargazer(glm12, glm13, glm14, glm15, type = "text",
  title = "Univariate variable effects on *T. stansburyi* abundance",
  colnames = FALSE, model.numbers = FALSE,
  dep.var.caption = "Climate variables", dep.var.labels = "Jan - June Averages",
  covariate.labels = c("Precipitation (mm)", "Max temperature (°C)", "Mean temperature (°C)", "Min temperature (°C)", "Constant"),
  keep.stat = c("n"), # number of observations. use "ll" for log likelihood
  single.row=TRUE,
  add.lines = list(c("AIC", round(AICc(glm12), 1), round(AICc(glm13), 1), round(AICc(glm14), 1), 
                     round(AICc(glm15), 1))),
  notes.align = "l", out = "tables/univar.climate-jan-jun.txt")
```

##### Floral
```{r message=FALSE, results='asis'} 
stargazer(fglm1, fglm2, fglm3, type = "text",
  title = "Univariate variable effects on *T. stansburyi* abundance",
  colnames = FALSE, model.numbers = FALSE,
  dep.var.caption = " ", dep.var.labels = "Floral variables",
  covariate.labels = c("Abundance", "Diversity", "Richness",  "Constant"),
  keep.stat = c("n"), # number of observations. use "ll" for log likelihood
  single.row=TRUE,
  add.lines = list(c("AIC", round(AICc(fglm1), 1), round(AICc(fglm2), 1), round(AICc(fglm3), 1))),
  notes.align = "l",
  out = "tables/univar.floral.txt")
```

##### Trees
```{r message=FALSE, results='asis'} 
stargazer(tglm1, tglm2, tglm3, type = "text",
  title = "Univariate variable effects on *T. stansburyi* abundance",
  colnames = FALSE, model.numbers = FALSE,
  dep.var.caption = " ", dep.var.labels = "Tree variables",
  covariate.labels = c("Mean canopy cover (%)", "Dead basal area (m2ha-1)", "Live basal area (m2ha-1)",  "Constant"),
  keep.stat = c("n"), # number of observations. use "ll" for log likelihood
  single.row=TRUE,
  add.lines = list(c("AIC", round(AICc(tglm1), 1), round(AICc(tglm2), 1), round(AICc(tglm3), 1))),
  notes.align = "l",
  out = "tables/univar.tree.txt")
```

##### Landscape
```{r message=FALSE, results='asis'} 
# Indices
stargazer(lglm1, lglm2, lglm3, type = "text",
  title = "Univariate variable effects on *T. stansburyi* abundance",
  colnames = FALSE, model.numbers = FALSE,
  dep.var.caption = "Landscape variables", dep.var.labels = "Indices",
  #covariate.labels = c("Diversity", "Richness", "Evenness", "Constant"),
  keep.stat = c("n"), # number of observations. use "ll" for log likelihood
  single.row=TRUE,
  add.lines = list(c("AIC", round(AICc(lglm1), 1), round(AICc(lglm2), 1), round(AICc(lglm3), 1))),
  notes.align = "l", out = "tables/univar.Landscape-indices.txt")

# Landscape proportions
stargazer(lglm4, lglm5, lglm6, lglm7, lglm8, type = "text",
  title = "Univariate variable effects on *T. stansburyi* abundance",
  colnames = FALSE, model.numbers = FALSE,
  dep.var.caption = "Landscape variables", dep.var.labels = "Land type proportions",
  covariate.labels = c("Barren (%)", "Coniferous Forest (%)", "Coniferous Forest (%)", "Rangeland (%)",
                       "Urban development (%)", "Constant"),
  keep.stat = c("n"), # number of observations. use "ll" for log likelihood
  single.row=TRUE,
  add.lines = list(c("AIC", round(AICc(lglm4), 1), round(AICc(lglm5), 1), round(AICc(lglm6), 1), 
                     round(AICc(lglm7), 1),round(AICc(lglm8), 1))),
  notes.align = "l", out = "tables/univar.Landscape-types.txt")
```


## 2) Correlations
### All
```{r}
cor.data<-cor(pvars[,-c(1:2)], use='complete.obs', method = "spearman")
pmat.data<-cor_pmat(cor.data, method = "spearman") # for ggcorrplot

corr.plot<-
  ggcorrplot(cor.data, lab = TRUE, type= "lower", p.mat = pmat.data, show.diag = T, sig.level = 0.1,
           ggtheme = ggplot2::theme_classic(), outline.col="white",
           colors = c("grey50", "grey70", "grey90")) +
  theme(plot.title = element_text(hjust = 0.5))
  
save_plot("sfigures\\corplot.predictVars.png", corr.plot, base_height=15, bg="white") 
```
Note: EVT

### Climate
#### With Climate Normals
```{r}
cor.cdata<-cor(zo.data.or[,c(17, 34:45, 49)], use='complete.obs', method = "spearman")
pmat.cdata<-cor_pmat(cor.cdata, method = "spearman") # for ggcorrplot

Ccorr.plot<-
  ggcorrplot(cor.cdata, lab = TRUE, type= "lower", p.mat = pmat.cdata, show.diag = T, sig.level = 0.1,
           ggtheme = ggplot2::theme_classic(), outline.col="white",
           colors = c("grey50", "grey70", "grey90")) + labs(title = "Climate Variables")+
  theme(plot.title = element_text(hjust = 0.5))
  
save_plot("sfigures\\corplot.climateVars.png", Ccorr.plot, base_height=7.5, bg="white") 
```

#### Without Climate Normals
```{r}
cor.cdata2<-cor(zo.data.or[,c(38:45,49)], use='complete.obs', method = "spearman")
pmat.cdata2<-cor_pmat(cor.cdata2, method = "spearman") # for ggcorrplot

Ccorr.plot2<-
  ggcorrplot(cor.cdata2, lab = TRUE, type= "lower", p.mat = pmat.cdata2, show.diag = T, sig.level = 0.1,
           ggtheme = ggplot2::theme_classic(), outline.col="white",
           colors = c("grey50", "grey70", "grey90")) + labs(title = "Climate Variables")+
  theme(plot.title = element_text(hjust = 0.5))
  
save_plot("sfigures\\corplot.climateVars2.png", Ccorr.plot2, base_height=7.5, bg="white") 
```
DD_accumulated is not correlated to normals, but is correlated with bi and qrt climates. 
Bi-temps are correlated with normal temps and min/mean qrt temps. 
Use Ann_ppt_mm and DD_accumulated

### Flora
```{r}
cor.pdata<-cor(zo.data.or[50:52], use='complete.obs', method = "spearman")
pmat.pdata<-cor_pmat(cor.pdata, method = "spearman") # for ggcorrplot

pcorr.plot<-
  ggcorrplot(cor.pdata, lab = TRUE, type= "lower", p.mat = pmat.pdata, show.diag = T, sig.level = 0.1,
           ggtheme = ggplot2::theme_classic(), outline.col="white",
           colors = c("grey50", "grey70", "grey90")) + labs(title = "Plant Variables")+
  theme(plot.title = element_text(hjust = 0.5))
  
save_plot("sfigures\\corplot.plantVars.png", pcorr.plot, base_height=7.5, bg="white") 
```
Not correlated, but none were significant predictors

### Tree
```{r}
cor.tdata<-cor(zo.data.or[,c(56,66:67)], use='complete.obs', method = "spearman")
pmat.tdata<-cor_pmat(cor.tdata, method = "spearman") # for ggcorrplot

tcorr.plot<-
  ggcorrplot(cor.tdata, lab = TRUE, type= "lower", p.mat = pmat.tdata, show.diag = T, sig.level = 0.1,
           ggtheme = ggplot2::theme_classic(), outline.col="white",
           colors = c("grey50", "grey70", "grey90")) + labs(title = "Tree Variables")+
  theme(plot.title = element_text(hjust = 0.5))
  
save_plot("sfigures\\corplot.treeVars.png", tcorr.plot, base_height=7.5, bg="white") 
```
Not correlated, but none were significant predictors

### Landscape
```{r}
# Landscape Indexes
cor.idata<-cor(zo.data.or[,c(40:42)], use='complete.obs', method = "spearman")
pmat.idata<-cor_pmat(cor.idata, method = "spearman") # for ggcorrplot

icorr.plot<-
  ggcorrplot(cor.idata, lab = TRUE, type= "lower", p.mat = pmat.idata, show.diag = T, sig.level = 0.1,
           ggtheme = ggplot2::theme_classic(), outline.col="white",
           colors = c("grey50", "grey70", "grey90")) + labs(title = "Landscape indexes")+
  theme(plot.title = element_text(hjust = 0.5))

# Landscape Types (43 & 45 Barren and Crops)
cor.ltdata<-cor(zo.data.or[,c(44, 46:48)], use='complete.obs', method = "spearman")
pmat.ltdata<-cor_pmat(cor.ltdata, method = "spearman") # for ggcorrplot

ltcorr.plot<-
  ggcorrplot(cor.ltdata, lab = TRUE, type= "lower", p.mat = pmat.ltdata, show.diag = T, sig.level = 0.1,
           ggtheme = ggplot2::theme_classic(), outline.col="white",
           colors = c("grey50", "grey70", "grey90")) + labs(title = "Landscape type variables")+
  theme(plot.title = element_text(hjust = 0.5))

# All Landscape vars
cor.ldata<-cor(zo.data.or[,c(40:44, 46:48)], use='complete.obs', method = "spearman")
pmat.ldata<-cor_pmat(cor.ldata, method = "spearman") # for ggcorrplot

lcorr.plot<-
  ggcorrplot(cor.ldata, lab = TRUE, type= "lower", p.mat = pmat.ldata, show.diag = T, sig.level = 0.1,
           ggtheme = ggplot2::theme_classic(), outline.col="white",
           colors = c("grey50", "grey70", "grey90")) + labs(title = "Landscape Variables")+
  theme(plot.title = element_text(hjust = 0.5))
  
save_plot("sfigures\\corplot.landIndex.png", icorr.plot, base_height=7.5, bg="white") 
save_plot("sfigures\\corplot.landTypeVars.png", ltcorr.plot, base_height=7.5, bg="white") 
save_plot("sfigures\\corplot.landVars.png", lcorr.plot, base_height=7.5, bg="white") 
```
Just index: none are *sig* correlated, but evenness and diversity are 94% correlated (???)
Just landscapes: Con Forests and Rangeland (-0.82)
All: EVT_H ~ EVT_J & EVT_rich, Rangeland and Indices, Rangeland and Con forests

## 3) Data check
### O.lig count
#### Sig var check
Sig predictors: none
Marginally sig predictors: Ann_tmin_C, qrt_tmax_C
```{r}
on1<- lm(sqrt(nOligGrowth)~Ann_tmin_C, data = zo.data)
plot(on1) # curved resids, normal

on2<- lm(sqrt(nOligGrowth)~qrt_tmax_C, data = zo.data)
plot(on2) # curved resids, normal

pairs(sqrt(nOligGrowth) ~ Ann_tmin_C + Ann_tmean_C + Ann_tmax_C + qrt_tmin_C + qrt_tmean_C + qrt_tmax_C, data = zo.data)

pairs((nOligGrowth) ~ Ann_tmin_C + qrt_tmax_C, data = zo.data) 
# doesn't seem to be a strong relationship between Olig and temp, but climate vars are very correlated (not independent?)
plot((zo.data$nOligGrowth), zo.data$Ann_tmin_C)
plot((zo.data$nOligGrowth), zo.data$qrt_tmax_C)
```

# Analysis
## Q1a) 
### O.lig n
If you look just at climate variables, Ann_tmin_C and qrt_tmax_C are not correlated
```{r}
on_mod<-lm(sqrt(nOligGrowth) ~ Ann_tmin_C * qrt_tmax_C, data = zo.data)
summary(on_mod) # all marginally sig
plot(on_mod) # fairly normal, curved resids

on_mod2<-lm(sqrt(nOligGrowth) ~ Ann_tmin_C + qrt_tmax_C, data = zo.data)
summary(on_mod2) # not sig. Interesting
plot(on_mod2) # fairly normal

# interaction or no interaction?
drop1(on_mod, test = "F") # interaction is marginally significant

op <- par(mfrow=c(2,2), mar=c(5,4,1,2))
plot(on_mod, add.smooth = F, which = 1)
E <- resid(on_mod)
hist(E, xlab = "Residuals", main = "")
plot(zo.data$Ann_tmin_C, E, xlab="Normal min temperature", ylab = "residuals")
plot(zo.data$qrt_tmax_C, E, xlab="May-June max temperature", ylab = "residuals")
par(op)

#Barlett’s test for homogeneity
bartlett.test(E, zo.data$Ann_tmin_C)
bartlett.test(E, zo.data$Ann_tmin_C)

E1 <- E[zo.data$Ann_tmin_C <= 1.5] # plot suggests different spread for observations above 1.5 than below 1.5
E2 <- E[zo.data$Ann_tmin_C > 1.5]
var.test(E1, E2) # not sig - good!

E3 <- E[zo.data$qrt_tmax_C <= 23.5] # from plot
E4 <- E[zo.data$qrt_tmax_C > 23.5]
var.test(E3, E4) # not sig - but close (p = 0.07)

# curved resids (from plot(on_mod)), suggests variables are not independent
plot(y = zo.data$Ann_tmin_C, x = zo.data$qrt_tmax_C) # correlated

```
### O.lig % 
```{r}
or_mod<-lm(oligRatio ~ stemdiv, data = zo.data)
summary(or_mod)
plot(or_mod) # some outliers, but fairly normal
```


## Q1b) T.stan by All vars
### Full model
```{r}
f_model<-glm(nTstanCells ~ Habitat + Ann_tmin_C + DD_accumulated + EVT_H + EVT_rich + EVT_J + Coniferous_Forest + WUI, data = zo.data.or, family = poisson())
plot(f_model) # megaphone resids, fairly normal
```

### Stepwise
```{r}
f_model_stp <- step(f_model, direction = "both", trace = 0)
summary(f_model_stp) 

# Predictor vars include: Ann_tmin_C + WUI
#AIC(f_model_stp) # 135.3
```
Habitat, min temp mean normals, and WUI landscapes are best predictors

### Dredge
```{r}
options(na.action = "na.fail", rank = "AIC")
f_model_drd<-dredge(f_model)

nrow(f_model_drd) #256

f_model_drd[1,]
head(f_model_drd)
# Best predictors: Ann_tmin_C + WUI

f_model_pdrd<-glm(nTstanCells ~ Ann_tmin_C + WUI, data = zo.data.or, family = poisson())
summary(f_model_pdrd)
# AIC: 137.6
```

### Check fit
#### Plotting resids
```{r}
E1 <- resid(f_model_pdrd, type="pearson")
F1 <- fitted(f_model_pdrd, type="response")

scatter.smooth(F1, E1, cex.lab = 1.5, xlab="Fitted values", ylab="Pearson Residuals")
abline(h = 0, lty=2)
plot(f_model_pdrd)


EP <- resid(f_model_pdrd, type = "pearson")
ED <- resid(f_model_pdrd, type = "deviance")
mu <- predict(f_model_pdrd, type = "response")
E <- zo.data.or$nTstanCells - mu
EP2 <- E / sqrt(7.630148 * mu)
op <- par(mfrow = c(2, 2))
plot(x = mu, y = E, main = "Response residuals")
plot(x = mu, y = EP, main = "Pearson residuals")
plot(x = mu, y = EP2,
main = "Pearson residuals scaled")
plot(x = mu, y = ED, main = "Deviance residuals")
par(op)
```

#### Over dispersion
```{r}
e2<-resid(f_model_pdrd, type="pearson")
n<-nrow(zo.data.or)
p<-length(coef(f_model_pdrd))
sum(e2^2)/(n-p) # overdispersed (1.9)

# or --> residules/dfs 
60.277/28 # 2.15 overdispersed
# quick fix --> Quasipoisson
pd_model_c<-glm(nTstanCells ~ Ann_tmin_C + WUI, data = zo.data.or, family = quasipoisson())
summary(pd_model_c)
```

### GLM-QP Full model 
```{r}
# interaction or no interaction? 
tqpglm<-glm(nTstanCells ~ EVT_J*WUI, data = zo.data.or, family = quasipoisson())
summary(tqpglm)

tqpglm1<-glm(nTstanCells ~ EVT_J + WUI, data = zo.data.or, family = quasipoisson())
summary(tqpglm1)

# is WUI correlated to EVT_J?
cor.test(zo.data.or$EVT_J, zo.data.or$WUI, method = "pearson") # 49 %, is sig. 
plot(EVT_J ~ WUI, data=zo.data.or)
```

## Q2)
### Tstan cells ~ Provisioned cells
#### With outlier
```{r}
glm.ntpc<- glm(nTstanCells ~  nTotProvised, data = zo.data, family = poisson()) 
tidy(glm.ntpc) # sig. AIC: 153.5
plot(glm.ntpc) # resids curved, normal

# check for over/underdispersion
e2<-resid(glm.ntpc, type="pearson")
n<-nrow(zo.data)
p<-length(coef(glm.ntpc))
sum(e2^2)/(n-p) # produces overdispersion (2.4)

# negative binomial glm
glm.ntpc.nb<-glm.nb(nTstanCells ~  nTotProvised, data = zo.data, link = "log") 
tidy(glm.ntpc.nb) # sig, lower RSE (16), 12 df, AIC 137.06
plot(glm.ntpc.nb) # curved resids, outlier pull

e2<-resid(glm.ntpc.nb, type="pearson")
p<-length(coef(glm.ntpc.nb))
sum(e2^2)/(n-p) # better (1.02)

glm.ntpc.nb1<-glm.nb(nTstanCells ~  sqrt(nTotProvised), data = zo.data, link = "log") 
tidy(glm.ntpc.nb1) # sig, lower RSE (16), 12 df, AIC 65.5
plot(glm.ntpc.nb1) # curved resids, not normal
```

Poisson model seems to fit best
#### Without outlier
```{r}
glm.ntpc.rmo<- glm(nTstanCells ~  nTotProvised, data = zo.data.or, family = poisson()) 
tidy(glm.ntpc.rmo) # sig. AIC: 130.85
plot(glm.ntpc.rmo) # curved resids, not really normal

# check for over/underdispersion
e2<-resid(glm.ntpc.rmo, type="pearson")
n<-nrow(zo.data.or)
p<-length(coef(glm.ntpc.rmo))
sum(e2^2)/(n-p) # produces overdispersion (1.91)

# negative binomial glm
glm.ntpc.rmo.nb<-glm.nb(nTstanCells ~  nTotProvised, data = zo.data.or, link = "log") 
tidy(glm.ntpc.rmo.nb) # sig, lower RSE (14), 11 df, AIC 56
plot(glm.ntpc.rmo.nb) # curved resids, not normal

e2<-resid(glm.ntpc.rmo.nb, type="pearson")
p<-length(coef(glm.ntpc.rmo.nb))
sum(e2^2)/(n-p) # still some overdispersion (1.09)
```

### Tstan cells ~ O.lig cells 
How does O. lignaria abundance predict T. stansburyi abundance?
```{r}
# with outlier
glm.nt1<-glm(nTstanCells ~ nOligGrowth, data=zo.data, family = poisson())
tidy(glm.nt1) # sig. AIC:75.648
plot(glm.nt1) # megaphone resids, oulier departure

glm.nt1.nb<-glm.nb(nTstanCells ~ nOligGrowth, data=zo.data, link="log")
tidy(glm.nt1.nb) # sig. AIC:235.4
plot(glm.nt1.nb) # resids ok, normal

# without outlier
glm.nt2<-glm(nTstanCells ~ nOligGrowth, data=zo.data.or, family = poisson())
tidy(glm.nt2) # sig. AIC:141.9
plot(glm.nt2) # curved resids, mostly normal

glm.nt2.nb<-glm.nb(nTstanCells ~ nOligGrowth, data=zo.data.or, link="log")
tidy(glm.nt2.nb) # sig. AIC:132.41
plot(glm.nt2.nb) # megaphone resids, normal
```

Does T. abundance abundance predict O. lignaria abundance?
How does O. lignaria abundance predict T. stansburyi abundance?
```{r}
lm.nt<-lm(nOligGrowth ~ nTstanCells, data=zo.data.or)
tidy(lm.nt) # sig
plot(lm.nt) # curved resids, normal
```

### O.lig Ratio ~ T.stan Ratio
How does T.stan brood ratios affect O. lignaria ratios
#### Plots
```{r}
plot(oligRatio ~ tstanRatio, data = zo.data.or) # slight decrease?
```
#### SLR
Note: Olig ratios transformed become normal, but T.stan ratios still zero heavy. Sqrt does seem to help
```{r}
# with outlier
lm.to1<-lm(oligRatio ~ tstanRatio, data = zo.data) 
tidy(lm.to1) # marginally sig
plot(lm.to1) # megaphone residuals, some outliers, but fairly normal
AIC(lm.to1)
shapiro.test(lm.to1$residuals) # sig

e2<-resid(lm.to1, type="pearson")
n<-nrow(zo.data.or)
p<-length(coef(lm.to1))
sum(e2^2)/(n-p) # under dispersion (0.05)

lm.to2<-lm(oligRatio ~ tstanRatio, data = zo.data.or)
tidy(lm.to2) # not sig.
plot(lm.to2) #  megaphone residuals, departure from normal
shapiro.test(lm.to2$residuals) # technically not sig

lm.to3<-lm(oligRatio ~ log(tstanRatio+1,base=10), data = zo.data.or)
tidy(lm.to3) # not sig
plot(lm.to3) # megaphone residuals, departure from normal

lm.to4<-lm(sqrt(oligRatio) ~ sqrt(tstanRatio), data = zo.data.or)
tidy(lm.to4) # sig. r2 = 0.3
plot(lm.to4) # worse

lm.to5<-lm(log(oligRatio+1, base=10) ~log(tstanRatio+1,base=10), data = zo.data)
tidy(lm.to5) # marginally sig. r2 = 0.3
plot(lm.to5) # megaphone residuals, some departure
```

### O.lig fitness ~  T.stan ratio
#### Plots
```{r}
# with T.stan outlier
## T. stan Ratio
plot(avgOligFMass_mg ~ tstanRatio, data = fw.data) # no difference
plot(avgOligMMass_mg ~ tstanRatio, data = mw.data) # no difference
plot(oligFRatio ~ tstanRatio, data = fw.data) # decrease
## T. stan abundance
plot(avgOligFMass_mg ~ nTstanCells, data = fw.data) # increase? Hard to say with outlier
plot(avgOligMMass_mg ~ nTstanCells, data = mw.data) # hard to say with outlier
plot(oligFRatio ~ nTstanCells, data = fw.data) # decrease

# no T.stan outlier
## T. stan Ratio
plot(avgOligFMass_mg ~ tstanRatio, data = fw.data.or) # no difference
plot(avgOligMMass_mg ~ tstanRatio, data = mw.data[-c(2),]) # no difference
plot(oligFRatio ~ tstanRatio, data = fw.data.or) # no difference
## T. stan abundance
plot(avgOligFMass_mg ~ nTstanCells, data = fw.data.or) # no difference
plot(avgOligMMass_mg ~ nTstanCells, data = mw.data[-c(2),]) # no difference
plot(oligFRatio ~ nTstanCells, data = fw.data.or) # decrease
```

#### SLR
##### tstanRatio
```{r}
lm.tmp<-lm(avgOligMMass_mg ~ tstanRatio, data = mw.data[-c(2),])
tidy(lm.tmp) # not sig
plot(lm.tmp) # normal

lm.tfp<-lm(avgOligFMass_mg ~ tstanRatio, data = fw.data.or)
tidy(lm.tfp) # not sig
plot(lm.tfp) # curved residuals, some outlier departure
shapiro.test(lm.tfp$residuals) # not sig

lm.tfr<-lm(oligFRatio ~ tstanRatio, data = fw.data.or)
tidy(lm.tfr) # marginally sig
plot(lm.tfr) # megaphone resids, some departure, but not bad
shapiro.test(lm.tfr$residuals) # not sig
```

##### nTstanCells
```{r}
lm.tm<-lm(avgOligMMass_mg ~ nTstanCells, data = mw.data[-c(2),])
tidy(lm.tm) # not sig
plot(lm.tm) # curved residuals, normal

lm.tf<-lm(avgOligFMass_mg ~ nTstanCells, data = fw.data.or)
tidy(lm.tf) # not sig
plot(lm.tf) # Some outliers, but not bad

lm.tfr<-lm(oligFRatio ~ nTstanCells, data = fw.data.or)
tidy(lm.tfr) #  sig
plot(lm.tfr) # megaphone resids, some departure, but not bad
shapiro.test(lm.tfr$residuals) # not sig
```

# Figures
## Q1) 
### Dredge
Ann_tmin_CC and WUI were sig
```{r}
pem_atmin <- plot(predictorEffect("Ann_tmin_C", f_model_pdrd), main = "", 
                  xlab = expression("Normal minimum temperature ("*~degree*C*")"), 
                  ylab = expression(paste(italic("T. stansburyi"), " abundance")), 
                  lines=list(col = "black"), lwd = 2)
pem_wui <- plot(predictorEffect("WUI", f_model_pdrd), main = "", 
                  xlab = expression("Low intensity development"), 
                  ylab = expression(paste(italic("T. stansburyi"), " abundance")), 
                  lines=list(col = "black"), lwd = 2)

pem_tstan<-plot_grid(pem_atmin, pem_wui, ncol=2, labels = c("A", "B"))
save_plot("figures\\tstan.landvars.pem.png", pem_tstan, base_height=7.5, bg="white")
```

## Q2) 
### Tstan Count ~ Provisioned cells
```{r}
# Poisson
tpc.tstan<-
ggplot(data = zo.data.or, aes(x=nTotProvised, y = nTstanCells))+
    geom_point(aes(color = Habitat, fill = Habitat, shape = Habitat), size = 5, color = "black")+
      scale_fill_manual(values=c("grey50", "grey70", "grey90")) +
      scale_shape_manual(values=c(21:23))+
    stat_smooth(method="glm", formula = y ~ x, color = "black", fill = "lightgray", method.args =
                  list(family = poisson))+
    geom_text_repel(aes(x = nTotProvised, label = Year3), size = 5)+
    xlab(expression(paste(italic("O. lignaria"), " provisioned cells")))+
    ylab(expression(paste("Total ", italic("T. stansburyi "), "count"))) +
    ylim(0, 10) + xlim(0,135)+
    theme_classic()+
    theme(plot.title = element_text(hjust = 0.5, size = 20), legend.position="right", 
          legend.text = element_text(size=16), axis.text.x = element_text(size=18), 
          axis.text.y = element_text(size=18), legend.title = element_text(size = 18),
          axis.title.x = element_text(size=20), axis.title.y =element_text(size=20),
          plot.margin=unit(c(1,1,1,1),"cm"))

# Negative Binomial
#ee <- emmeans(glm.ntpc.rmo.nb, "nTotProvised", type = "response", offset = log(1))
# https://cran.r-project.org/web/packages/emmeans/vignettes/sophisticated.html#offsets

#tpc.tstan.nb<-
#https://stackoverflow.com/questions/76742036/how-to-make-a-plot-of-a-negative-binomial-regression-fitted-values-and-95-conf

save_plot("figures\\tpc.tstan.png", tpc.tstan, base_height = 5.5, base_aspect_ratio = 2, bg="white")
```

### Tstan Count ~ Olig Count
```{r}
tn.on.lm<-
ggplot(data = zo.data.or, aes(x = nTstanCells, y = nOligGrowth))+
    geom_point(aes(color = Habitat, fill = Habitat, shape = Habitat), size = 5, color = "black")+
    scale_fill_manual(values=c("grey50", "grey70", "grey90")) +
    scale_shape_manual(values=c(21:23))+
    stat_smooth(method="lm", color = "black", fill = "lightgray")+
    geom_text_repel(aes(x = nTstanCells, label = Year3), size = 5)+ 
    xlab(expression(paste("Total ", italic("T. stansburyi"), " count"))) +  
    ylab(expression(paste("Total ", italic("O. lignaria"), " count")))+
    xlim(0,10) + ylim(0,100)+ 
    theme_classic()+
    theme(plot.title = element_text(hjust = 0.5, size = 20), legend.position="right", 
          legend.text = element_text(size=16), axis.text.x = element_text(size=18), 
          axis.text.y = element_text(size=18), legend.title = element_text(size = 18),
          axis.title.x = element_text(size=20), axis.title.y =element_text(size=20),
          plot.margin=unit(c(1,1,1,1),"cm"))

save_plot("figures\\tstann.olig.lm.png", tn.on.lm, base_height=5.5, base_aspect_ratio = 3, bg="white")
```

### O.lig Ratio ~ T.stan Ratio
```{r}
tr.or.lm<-
ggplot(data = zo.data.or, aes(x = (tstanRatio*100), y = (oligRatio*100)))+
    geom_point(aes(color = Habitat, fill = Habitat, shape = Habitat), size = 5, color = "black")+
    scale_fill_manual(values=c("grey50", "grey70", "grey90")) +
    scale_shape_manual(values=c(21:23))+
    #stat_smooth(method="lm", color = "black", fill = "lightgray", linetype = 2)+
    geom_text_repel(aes(x = (tstanRatio*100), label = Year3), size = 5)+
    ylab(expression(paste(italic("O. lignaria"), " brood ratio (%)")))+
    xlab(expression(paste(italic("T. stansburyi")," brood ratio (%)"))) +
    xlim(0,20)+ ylim(0,100)+
    theme_classic()+
    theme(plot.title = element_text(hjust = 0.5, size = 20), legend.position="right", 
          legend.text = element_text(size=16), axis.text.x = element_text(size=18), 
          axis.text.y = element_text(size=18), legend.title = element_text(size = 18),
          axis.title.x = element_text(size=20), axis.title.y =element_text(size=20),
          plot.margin=unit(c(1,1,1,1),"cm"))
save_plot("figures\\tstanr.oligr.lm.png", tr.or.lm, base_height=5.5,base_aspect_ratio = 2, bg="white")
```

### O.lig F Ratio ~ T.stan Ratio/count
```{r}
tr.fr.lm<-
ggplot(data = fw.data.or, aes(x = (tstanRatio*100), y = (oligFRatio*100)))+
    geom_point(aes(color = Habitat, fill = Habitat, shape = Habitat), size = 5, color = "black")+
    scale_fill_manual(values=c("grey50", "grey70", "grey90")) +
    scale_shape_manual(values=c(21:23))+
    stat_smooth(method="lm", color = "black", fill = "lightgray",linetype = 2)+
    geom_text_repel(aes(x = (tstanRatio*100), label = Year3), size = 5)+
    ylab(expression(paste(italic("O. lignaria"), " female ratio (%) ")))+
    xlab(expression(paste(italic("T. stansburyi")," brood ratio (%)"))) +
    xlim(0,20)+ ylim(0,100)+
    theme_classic()+
    theme(plot.title = element_text(hjust = 0.5, size = 20), legend.position="right", 
          legend.text = element_text(size=16), axis.text.x = element_text(size=18), 
          axis.text.y = element_text(size=18), legend.title = element_text(size = 18),
          axis.title.x = element_text(size=20), axis.title.y =element_text(size=20),
          plot.margin=unit(c(1,1,1,1),"cm"))

save_plot("figures\\tstanr.oligFr.lm.png", tr.fr.lm, base_height=5.5,base_aspect_ratio = 2, bg="white")

tn.fr.lm<-
ggplot(data = fw.data.or, aes(x = nTstanCells, y = (oligFRatio*100)))+
    geom_point(aes(color = Habitat, fill = Habitat, shape = Habitat), size = 5, color = "black")+
    scale_fill_manual(values=c("grey50", "grey70", "grey90")) +
    scale_shape_manual(values=c(21:23))+
    stat_smooth(method="lm", color = "black", fill = "lightgray")+
    geom_text_repel(aes(x = (tstanRatio*100), label = Year3), size = 5)+
    ylab(expression(paste(italic("O. lignaria"), " female ratio (%) ")))+
    xlab(expression(paste("Total ", italic("T. stansburyi"), " count"))) +  
    xlim(0,10)+ ylim(0,100)+
    theme_classic()+
    theme(plot.title = element_text(hjust = 0.5, size = 20), legend.position="right", 
          legend.text = element_text(size=16), axis.text.x = element_text(size=18), 
          axis.text.y = element_text(size=18), legend.title = element_text(size = 18),
          axis.title.x = element_text(size=20), axis.title.y =element_text(size=20),
          plot.margin=unit(c(1,1,1,1),"cm"))

save_plot("figures\\tstann.oligFr.lm.png", tn.fr.lm, base_height=5.5,base_aspect_ratio = 2, bg="white")
```

### Combine all
```{r}
tstann.olign.all=ggarrange(tpc.tstan, tn.on.lm, tr.or.lm, tn.fr.lm,  
                               ncol=2, nrow = 2, common.legend = TRUE, legend = "right", 
                               labels = c("A", "B", "C", "D"))
save_plot("figures\\tstann.olign.all.png", tstann.olign.all, base_height=10, base_aspect_ratio = 2, bg="white")
```
